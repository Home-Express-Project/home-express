name: Database Schema Validation

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'backend/home-express-api/src/main/resources/db/migration/**'
      - 'database/**'
      - '.github/workflows/database-validation.yml'
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'backend/home-express-api/src/main/resources/db/migration/**'
      - 'database/**'

jobs:
  validate-migrations:
    name: Validate Flyway Migrations
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_root_password
          MYSQL_DATABASE: home_express_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u test_user -ptest_password; do
            echo "Waiting for MySQL..."
            sleep 2
          done
          echo "MySQL is ready!"
      
      - name: Run Flyway Info
        working-directory: backend/home-express-api
        run: |
          mvn flyway:info \
            -Dflyway.url=jdbc:mysql://127.0.0.1:3306/home_express_test \
            -Dflyway.user=test_user \
            -Dflyway.password=test_password
      
      - name: Run Flyway Validate
        working-directory: backend/home-express-api
        run: |
          mvn flyway:validate \
            -Dflyway.url=jdbc:mysql://127.0.0.1:3306/home_express_test \
            -Dflyway.user=test_user \
            -Dflyway.password=test_password
      
      - name: Run Flyway Migrate
        working-directory: backend/home-express-api
        run: |
          mvn flyway:migrate \
            -Dflyway.url=jdbc:mysql://127.0.0.1:3306/home_express_test \
            -Dflyway.user=test_user \
            -Dflyway.password=test_password
      
      - name: Verify Schema
        run: |
          mysql -h 127.0.0.1 -P 3306 -u test_user -ptest_password home_express_test \
            -e "SHOW TABLES;"
      
      - name: Check Core Tables
        run: |
          mysql -h 127.0.0.1 -P 3306 -u test_user -ptest_password home_express_test \
            -e "SELECT COUNT(*) as total_tables FROM information_schema.tables 
                WHERE table_schema='home_express_test' AND table_type='BASE TABLE';"
      
      - name: Validate Foreign Keys
        run: |
          mysql -h 127.0.0.1 -P 3306 -u test_user -ptest_password home_express_test \
            -e "SELECT COUNT(*) as foreign_keys FROM information_schema.KEY_COLUMN_USAGE 
                WHERE table_schema='home_express_test' AND referenced_table_name IS NOT NULL;"
      
      - name: Check Migration History
        run: |
          mysql -h 127.0.0.1 -P 3306 -u test_user -ptest_password home_express_test \
            -e "SELECT version, description, type, installed_on, success 
                FROM flyway_schema_history ORDER BY installed_rank;"

  schema-consistency-check:
    name: Schema Consistency Check
    runs-on: ubuntu-latest
    needs: validate-migrations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check migration file naming
        run: |
          cd backend/home-express-api/src/main/resources/db/migration
          
          # Check all files follow naming convention
          for file in V*.sql; do
            if [[ ! "$file" =~ ^V[0-9]+__[A-Za-z0-9_]+\.sql$ ]]; then
              echo "ERROR: Invalid migration filename: $file"
              echo "Expected format: V{number}__{description}.sql"
              exit 1
            fi
          done
          
          echo "OK - All migration files follow naming convention"
      
      - name: Check for SQL syntax errors
        run: |
          cd backend/home-express-api/src/main/resources/db/migration
          
          # Basic SQL syntax checks
          for file in *.sql; do
            echo "Checking $file..."
            
            # Check for common SQL errors
            if grep -q "CREATE TABLE.*WITHOUT.*PRIMARY KEY" "$file"; then
              echo "WARNING: Table without PRIMARY KEY in $file"
            fi
            
            # Check for missing semicolons at end
            if ! tail -1 "$file" | grep -q ";"; then
              echo "WARNING: Missing semicolon at end of $file"
            fi
          done
          
          echo "OK - Basic SQL syntax checks passed"
      
      - name: Generate migration report
        run: |
          echo "## Migration Files" > migration-report.md
          echo "" >> migration-report.md
          
          cd backend/home-express-api/src/main/resources/db/migration
          for file in V*.sql; do
            lines=$(wc -l < "$file")
            echo "- **$file**: $lines lines" >> ../../../../migration-report.md
          done
          
          cat ../../../../migration-report.md
      
      - name: Upload migration report
        uses: actions/upload-artifact@v3
        with:
          name: migration-report
          path: migration-report.md

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate-migrations, schema-consistency-check]
    if: failure()
    
    steps:
      - name: Send notification
        run: |
          echo "Database migration validation failed!"
          echo "Please check the workflow logs for details."
          # Add Slack/Discord webhook notification here if needed
